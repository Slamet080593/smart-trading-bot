const axios = require('axios');
require('dotenv').config();

// --- Konfigurasi
const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

const forexPairs = [
  "eurusd", "usdjpy", "gbpusd", "audusd", "usdchf",
  "eurchf", "usdcad", "nzdusd", "eurjpy", "gbpjpy"
];

const cryptoCoins = [
  "bitcoin", "ethereum", "binancecoin", "solana", "ripple"
];

// --- Function ambil harga Forex
async function fetchForexHistory(pair) {
  try {
    const url = `https://api.twelvedata.com/time_series?symbol=${pair.toUpperCase()}&interval=1h&outputsize=24&apikey=${process.env.TWELVE_API_KEY}`;
    const res = await axios.get(url);
    return res.data.values.map(v => parseFloat(v.close));
  } catch (err) {
    console.error(`Error Forex ${pair.toUpperCase()}:`, err.message);
    return [];
  }
}

// --- Function ambil harga Crypto dari Coingecko
async function fetchCryptoHistory(coin) {
  try {
    const url = `https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=usd&days=1&interval=hourly`;
    const res = await axios.get(url);
    return res.data.prices.map(p => p[1]);
  } catch (err) {
    console.error(`Error Crypto ${coin}:`, err.message);
    return [];
  }
}

// --- Analisa Sinyal
function analyzeSignal(prices) {
  if (prices.length < 20) return null;

  const lastPrice = prices[prices.length - 1];
  const prevPrice = prices[prices.length - 2];

  const ma5 = prices.slice(-5).reduce((a, b) => a + b, 0) / 5;
  const ma20 = prices.slice(-20).reduce((a, b) => a + b, 0) / 20;

  if (prevPrice < ma5 && lastPrice > ma5 && lastPrice > ma20) {
    return 'BUY';
  } else if (prevPrice > ma5 && lastPrice < ma5 && lastPrice < ma20) {
    return 'SELL';
  } else {
    return null;
  }
}

// --- Kirim ke Telegram
async function sendTelegramMessage(message) {
  try {
    const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
    await axios.post(url, {
      chat_id: TELEGRAM_CHAT_ID,
      text: message
    });
    console.log("Sinyal terkirim ke Telegram.");
  } catch (err) {
    console.error("Gagal kirim Telegram:", err.message);
  }
}

// --- Main Bot
async function main() {
  let signals = [];

  // Analisa Forex
  for (const pair of forexPairs) {
    const prices = await fetchForexHistory(pair);
    const signal = analyzeSignal(prices);
    if (signal) {
      signals.push(`${signal} ${pair.toUpperCase()} ➔ Hold 1-2 jam`);
    }
  }

  // Analisa Crypto
  for (const coin of cryptoCoins) {
    const prices = await fetchCryptoHistory(coin);
    const signal = analyzeSignal(prices);
    if (signal) {
      signals.push(`${signal} ${coin.toUpperCase()} ➔ Hold 1-2 jam`);
    }
  }

  // Kirim ke Telegram
  if (signals.length > 0) {
    const message = `Sinyal Trading:\n\n${signals.map(s => `- ${s}`).join('\n')}\n\nAuto generated by SmartBot.`;
    await sendTelegramMessage(message);
  } else {
    await sendTelegramMessage("Yah ga ada sinyal bosku.");
  }
}

main();
